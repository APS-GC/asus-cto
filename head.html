<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="/scripts/aem.js" type="module"></script>
<script src="/scripts/scripts.js" type="module"></script>
<link rel="stylesheet" href="/styles/styles.css"/>
<!--<link rel="stylesheet" href="/styles/site.css"/>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js" integrity="sha512-Ysw1DcK1P+uYLqprEAzNQJP+J4hTx4t/3X2nbVwszao8wD+9afLjBQYjz7Uk4ADP+Er++mJoScI42ueGtQOzEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<!-- Dynamic SEO Meta Tags -->
<script type="module">
  // Import getMetadata function from aem.js
  import { getMetadata } from '/scripts/aem.js';
  
  // Function to create and append meta tag
  function createMetaTag(name, content, type = 'name') {
    if (!content) return;
    
    const existingMeta = document.querySelector(`meta[${type}="${name}"]`);
    if (existingMeta) {
      existingMeta.content = content;
    } else {
      const meta = document.createElement('meta');
      meta.setAttribute(type, name);
      meta.content = content;
      document.head.appendChild(meta);
    }
  }
  
  // Function to create and append link tag
  function createLinkTag(rel, href) {
    if (!href) return;
    
    const existingLink = document.querySelector(`link[rel="${rel}"]`);
    if (existingLink) {
      existingLink.href = href;
    } else {
      const link = document.createElement('link');
      link.rel = rel;
      link.href = href;
      document.head.appendChild(link);
    }
  }
  
  // Function to set HTML lang attribute
  function setPageLanguage(lang) {
    if (!lang) return;
    document.documentElement.lang = lang;
  }
  
  // Function to add JSON-LD structured data
  function addStructuredData(data) {
    const script = document.createElement('script');
    script.type = 'application/ld+json';
    script.textContent = JSON.stringify(data);
    document.head.appendChild(script);
  }
  
  // Function to get UE page metadata - checks multiple sources
  function getUEPageMetadata(name) {
    // 1. Try traditional meta tags first (for non-UE environments)
    let value = getMetadata(name);
    if (value) return value;
    
    // 2. Check if we're in UE environment and try to get from page model
    if (typeof window !== 'undefined' && window.aue) {
      try {
        // Try to get from UE context
        const pageModel = window.aue.getPageModel?.();
        if (pageModel && pageModel[name]) {
          return pageModel[name];
        }
      } catch (e) {
        // UE API not available or different structure
      }
    }
    
    // 3. Check main element data attributes (where UE might store page metadata)
    const main = document.querySelector('main');
    if (main) {
      const dataAttr = `data-${name.toLowerCase()}`;
      if (main.hasAttribute(dataAttr)) {
        return main.getAttribute(dataAttr);
      }
      
      // Check camelCase version
      const camelCaseAttr = `data-${name}`;
      if (main.hasAttribute(camelCaseAttr)) {
        return main.getAttribute(camelCaseAttr);
      }
    }
    
    // 4. Check body element data attributes
    const bodyDataAttr = `data-${name.toLowerCase()}`;
    if (document.body.hasAttribute(bodyDataAttr)) {
      return document.body.getAttribute(bodyDataAttr);
    }
    
    // 5. Check for UE model data in script tags
    const ueModelScript = document.querySelector('script[type="application/json"][data-aue-model="page"]');
    if (ueModelScript) {
      try {
        const modelData = JSON.parse(ueModelScript.textContent);
        if (modelData[name]) {
          return modelData[name];
        }
      } catch (e) {
        // Invalid JSON
      }
    }
    
    return '';
  }

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', () => {
    // Get page metadata
    const title = getMetadata('jcr:title') || document.title;
    const description = getMetadata('jcr:description');
    const keywords = getMetadata('keywords');
    const canonicalUrl = getMetadata('canonicalUrl');
    const pageLanguage = getMetadata('pageLanguage');
    const robots = getMetadata('robots');
    const author = getMetadata('author');
    const ogImage = getMetadata('ogImage');
    const ogImageAlt = getMetadata('ogImageAlt');
    const ogType = getMetadata('ogType') || 'website';
    const pageVideo = getMetadata('pageVideo');
    const videoTrack = getMetadata('videoTrack');
    const videoDescription = getMetadata('videoDescription');
    const publishDate = getMetadata('publishDate');
    const modifiedDate = getMetadata('modifiedDate');
    
    // Set page language
    setPageLanguage(pageLanguage);
    
    // Basic SEO meta tags
    createMetaTag('description', description);
    createMetaTag('keywords', keywords);
    createMetaTag('robots', robots || 'index,follow');
    createMetaTag('author', author);
    
    // Canonical URL
    createLinkTag('canonical', canonicalUrl || window.location.href);
    
    // Open Graph meta tags
    createMetaTag('og:title', title, 'property');
    createMetaTag('og:description', description, 'property');
    createMetaTag('og:type', ogType, 'property');
    createMetaTag('og:url', canonicalUrl || window.location.href, 'property');
    createMetaTag('og:site_name', 'ASUS', 'property');
    
    if (ogImage) {
      createMetaTag('og:image', ogImage, 'property');
      createMetaTag('og:image:alt', ogImageAlt || title, 'property');
      createMetaTag('og:image:width', '1200', 'property');
      createMetaTag('og:image:height', '630', 'property');
    }
    
    // Video meta tags
    if (pageVideo) {
      createMetaTag('og:video', pageVideo, 'property');
      createMetaTag('og:video:type', 'video/mp4', 'property');
      if (videoDescription) {
        createMetaTag('video:description', videoDescription, 'property');
      }
    }
    
    // Twitter Card meta tags
    createMetaTag('twitter:card', ogImage ? 'summary_large_image' : 'summary');
    createMetaTag('twitter:title', title);
    createMetaTag('twitter:description', description);
    if (ogImage) {
      createMetaTag('twitter:image', ogImage);
      createMetaTag('twitter:image:alt', ogImageAlt || title);
    }
    
    // Article-specific meta tags
    if (ogType === 'article') {
      if (publishDate) {
        createMetaTag('article:published_time', publishDate, 'property');
      }
      if (modifiedDate) {
        createMetaTag('article:modified_time', modifiedDate, 'property');
      }
      if (author) {
        createMetaTag('article:author', author, 'property');
      }
    }
    
    // Structured Data (JSON-LD)
    const structuredData = {
      "@context": "https://schema.org",
      "@type": ogType === 'article' ? 'Article' : 'WebPage',
      "name": title,
      "headline": title,
      "description": description,
      "url": canonicalUrl || window.location.href,
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": canonicalUrl || window.location.href
      }
    };
    
    if (author) {
      structuredData.author = {
        "@type": "Person",
        "name": author
      };
    }
    
    if (publishDate) {
      structuredData.datePublished = publishDate;
    }
    
    if (modifiedDate) {
      structuredData.dateModified = modifiedDate;
    }
    
    if (ogImage) {
      structuredData.image = {
        "@type": "ImageObject",
        "url": ogImage,
        "width": 1200,
        "height": 630
      };
    }
    
    if (pageVideo) {
      structuredData.video = {
        "@type": "VideoObject",
        "contentUrl": pageVideo,
        "description": videoDescription || title,
        "name": title
      };
      
      if (videoTrack) {
        structuredData.video.caption = videoTrack;
      }
    }
    
    // Add publisher information
    structuredData.publisher = {
      "@type": "Organization",
      "name": "ASUS",
      "logo": {
        "@type": "ImageObject",
        "url": "/icons/asus-logo.svg"
      }
    };
    
    addStructuredData(structuredData);
    
    // Handle page background color from metadata (using UE-aware function)
    const pageBackgroundColor = getUEPageMetadata('pageBackgroundColor');
    if (pageBackgroundColor) {
      document.body.classList.add(pageBackgroundColor);
      console.log('Initial page background applied:', pageBackgroundColor);
    }
  });

  // Universal Editor Integration for Dynamic Metadata Updates
  function updatePageBackground() {
    const pageBackgroundColor = getUEPageMetadata('pageBackgroundColor');
    
    // Remove existing page background classes
    const existingBgClasses = ['page-bg-light-grey', 'page-bg-dark', 'page-bg-primary'];
    existingBgClasses.forEach(cls => document.body.classList.remove(cls));
    
    // Apply new background class if specified
    if (pageBackgroundColor) {
      document.body.classList.add(pageBackgroundColor);
      console.log('Applied page background class:', pageBackgroundColor);
    }
  }
  
  // Enhanced UE event handling
  function handleUEPageUpdate(event) {
    console.log('UE page update detected:', event.detail);
    
    // Check if this is a page-level update
    const detail = event.detail;
    const resource = detail?.request?.target?.resource || detail?.response?.updates?.[0]?.resource;
    
    if (resource && (resource.includes('jcr:content') || resource.includes('/main'))) {
      console.log('Page metadata update detected, refreshing background...');
      setTimeout(() => {
        updatePageBackground();
        
        // Also trigger a complete page refresh of metadata processing
        const main = document.querySelector('main');
        if (main && typeof window.decorateSections === 'function') {
          window.decorateSections(main);
        }
      }, 100);
    }
  }
  
  // Listen for UE metadata changes
  if (typeof window !== 'undefined') {
    // Listen for various UE events
    document.addEventListener('aue:content-patch', handleUEPageUpdate);
    document.addEventListener('aue:content-update', handleUEPageUpdate);
    document.addEventListener('aue:content-add', handleUEPageUpdate);
    document.addEventListener('aue:content-move', handleUEPageUpdate);
    
    // Also listen for direct model updates
    document.addEventListener('aue:model-update', (event) => {
      console.log('UE model update:', event.detail);
      setTimeout(updatePageBackground, 100);
    });
  }
</script>
